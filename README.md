# Техническая документация приложения JSON Viewer

## Введение

Приложение JSON Viewer — это WPF-приложение, разработанное с использованием паттерна MVVM на платформе .NET Framework 4.8. Оно предоставляет пользователям возможность загружать, парсить и интерактивно просматривать JSON-файлы в древовидной структуре. Приложение поддерживает функции виртуализации для эффективного отображения больших JSON-файлов, поиск внутри данных JSON и оценку прогресса загрузки на основе предыдущих скоростей парсинга.

## Общий обзор

- **Назначение**: Обеспечить удобный интерфейс для просмотра и поиска данных в формате JSON.
- **Ключевые возможности**:
  - Загрузка и парсинг JSON-файлов.
  - Отображение данных JSON в TreeView с возможностью разворачивания и сворачивания узлов.
  - Поддержка виртуализации для эффективной обработки больших JSON-файлов.
  - Функциональность поиска внутри данных JSON, как в основном окне, так и в отдельном окне поиска.
  - Оценка прогресса загрузки файла на основе ранее сохраненных скоростей парсинга.
- **Архитектура**: Использует паттерн MVVM с внедрением зависимостей (Dependency Injection) для лучшей разделяемости и тестируемости кода.

## Системные требования

- **Операционная система**: Windows 7 или более поздняя версия.
- **Фреймворк**: .NET Framework 4.8.
- **Аппаратное обеспечение**: Достаточный объем памяти и мощности процессора для обработки больших JSON-файлов (до 500 МБ).

## Архитектура

### Паттерн MVVM

Приложение следует архитектурному паттерну MVVM, который разделяет разработку графического пользовательского интерфейса (GUI) от бизнес-логики или логики бэкэнда (модели данных):

- **Model (Модель)**: Представляет данные и бизнес-логику.
- **View (Представление)**: Элементы пользовательского интерфейса.
- **ViewModel (Модель представления)**: Выступает посредником между View и Model, обрабатывая логику представления и привязку данных.

### Внедрение зависимостей (Dependency Injection)

Приложение использует внедрение зависимостей для управления зависимостями между классами, делая его более модульным и удобным для тестирования. Сервисы и компоненты регистрируются в центральном месте и внедряются там, где это необходимо.

### Сервисы

Определены несколько сервисов для обработки специфических функций:

- **IJsonParser**: Парсит JSON-файлы в древовидную структуру.
- **ISearchService**: Обеспечивает возможности поиска внутри данных JSON.
- **IFileService**: Обрабатывает операции с файлами, такие как проверка размера и чтение.
- **IProgressUpdater**: Обновляет прогресс-бар во время загрузки файла.
- **ISpeedManager**: Управляет сохранением и загрузкой скоростей парсинга для оценки прогресса.
- **IClipboardService**: Обрабатывает копирование текста в буфер обмена.
- **IFileDialogService**: Открывает диалоговые окна для выбора JSON-файлов.
- **INavigationService**: Управляет навигацией между различными представлениями/окнами.

## Элементы пользовательского интерфейса (UI)

### Главное окно

- **Заголовок**: JSON Viewer
- **Компоненты**:
  - **Кнопка "Открыть JSON файл"**: Позволяет пользователям выбрать и загрузить JSON-файл.
  - **Кнопка "Очистить вывод"**: Очищает текущее представление JSON.
  - **Кнопка "Поиск"**: Открывает окно поиска при включенной виртуализации.
  - **Кнопка "Включить\Выключить виртуализацию"**: Включает или отключает виртуализацию.
  - **Кнопка "Развернуть/Свернуть"**: Разворачивает или сворачивает все узлы в TreeView.
  - **Прогресс-бар**: Отображает прогресс загрузки и парсинга JSON-файла.
  - **Сообщение о статусе**: Показывает сообщения о статусе загрузки или ошибки.
  - **Информационные метки**: Показывают количество найденных результатов и текущий индекс результата.
  - **TreeView**: Отображает данные JSON в иерархической древовидной структуре.
    - Поддерживает контекстное меню для копирования имени, значения или обоих свойств JSON.
    - Позволяет разворачивать и сворачивать отдельные узлы.

### Окно поиска

- **Заголовок**: Поиск по JSON
- **Компоненты**:
  - **Поле ввода поиска**: Позволяет пользователям вводить поисковые запросы.
  - **Кнопка "Искать"**: Инициирует поиск.
  - **Кнопки "Предыдущий"/"Следующий"**: Перемещаются по результатам поиска.
  - **Результаты поиска**: Отображают текущий результат поиска в TreeView.
  - **Информационные метки**: Показывают количество найденных результатов и текущий индекс результата.

## Функциональные возможности

### Открытие и парсинг JSON-файлов

- **Выбор файла**: Пользователи могут выбрать JSON-файл, нажав на кнопку "Открыть JSON файл", что откроет диалоговое окно выбора файла.
- **Проверка размера файла**: Приложение проверяет, чтобы выбранный файл не превышал 500 МБ.
- **Парсинг**: JSON-файл парсится асинхронно, чтобы избежать зависания UI.
- **Оценка прогресса**:
  - Прогресс-бар отображает оценочный прогресс загрузки и парсинга файла.
  - Оценка основывается на размере файла и средней скорости парсинга, записанной из предыдущих операций.
- **Оценка и сохранение скорости**:
  - Приложение измеряет время, затраченное на парсинг каждого файла, и вычисляет скорость парсинга (МБ/с).
  - Скорость парсинга сохраняется с помощью сервиса `ISpeedManager` для будущих оценок прогресса.

### Просмотр JSON в TreeView

- **Структура TreeView**:
  - Данные JSON отображаются в иерархическом TreeView.
  - Каждый узел представляет свойство или значение JSON.
  - Узлы могут быть развернуты или свернуты индивидуально.
- **Контекстное меню**:
  - Щелчок правой кнопкой мыши на узле открывает контекстное меню с опциями копирования имени, значения или обоих свойств.
- **Виртуализация**:
  - При включенной виртуализации улучшается производительность за счет рендеринга только видимых узлов.
  - При отключенной виртуализации все узлы рендерятся, что позволяет искать внутри TreeView и разворачивать/сворачивать все узлы.
- **Развернуть/Свернуть все**:
  - Пользователи могут разворачивать или сворачивать все узлы с помощью кнопки "Развернуть все" или "Свернуть все".
  - Состояние разворачивания переключается при каждом нажатии.

### Поиск по JSON

#### Поиск в главном окне (без виртуализации)

- **Включение поиска**:
  - Чтобы включить поиск внутри TreeView, пользователи должны отключить виртуализацию, нажав на кнопку "Выключить виртуализацию".
- **Функциональность поиска**:
  - Появляется панель поиска, позволяющая вводить поисковые запросы.
  - Приложение выделяет совпадения непосредственно внутри TreeView.
  - Кнопки навигации позволяют перемещаться между найденными совпадениями.
- **Выделение совпадений**:
  - Соответствующие узлы выделяются и прокручиваются в поле зрения.
  - Родительские узлы соответствующих узлов разворачиваются для отображения совпадений.

#### Поиск в окне поиска (с виртуализацией)

- **Открытие окна поиска**:
  - При включенной виртуализации пользователи могут нажать на кнопку "Поиск", чтобы открыть отдельное окно поиска.
- **Функциональность поиска**:
  - Пользователи вводят поисковые запросы в окне поиска.
  - Каждое совпадение отображается как отдельная ветка в TreeView.
  - Кнопки навигации позволяют перемещаться между найденными совпадениями.
- **Результаты поиска**:
  - Отображается только путь к соответствующему узлу, обеспечивая контекст.
  - Структура показывает иерархию, ведущую к каждому совпадению.

## Детали реализации

### MainViewModel

Класс `MainViewModel` отвечает за управление данными и командами главного окна.

#### Ключевые свойства

- **IsVirtualizationEnabled**: Определяет, включена ли виртуализация.
- **JsonTreeItems**: Коллекция объектов `JsonTreeItem`, отображаемых в TreeView.
- **Progress**: Представляет значение прогресса для прогресс-бара.
- **StatusMessage**: Отображает сообщения, связанные с загрузкой и парсингом файла.
- **IsTreeExpanded**: Указывает, развернуто ли дерево полностью или свернуто.
- **AreSearchControlsVisible**: Управляет видимостью элементов управления поиска на основе виртуализации и наличия данных.
- **VirtualizationButtonText**: Обновляет текст кнопки переключения виртуализации в зависимости от текущего состояния.

#### Ключевые команды

- **OpenFileCommand**: Открывает диалоговое окно для выбора JSON-файла.
- **ClearCommand**: Очищает TreeView JSON.
- **ToggleVirtualizationCommand**: Включает или отключает виртуализацию.
- **ToggleExpandCollapseCommand**: Разворачивает или сворачивает все узлы в TreeView.
- **OpenSearchWindowCommand**: Открывает окно поиска при включенной виртуализации.
- **CopyNameCommand**: Копирует имя выбранного свойства JSON в буфер обмена.
- **CopyValueCommand**: Копирует значение выбранного свойства JSON в буфер обмена.
- **CopyNameAndValueCommand**: Копирует и имя, и значение выбранного свойства JSON в буфер обмена.

#### Методы

- **OpenJsonFileAsync()**: Асинхронно обрабатывает процесс открытия и парсинга JSON-файла.
- **LoadAndParseJsonFileAsync(string filePath)**: Выполняет проверку размера файла, инициирует парсинг, обновляет прогресс и обрабатывает исключения.
- **EstimateProcessingTime(double fileSizeInMegaByte)**: Оценивает время, необходимое для обработки файла, на основе предыдущих скоростей парсинга.
- **UpdateProcessingSpeed(double fileSizeInMegaByte, double timeInSeconds)**: Обновляет сохраненную скорость парсинга после обработки файла.
- **ToggleExpandCollapse()**: Переключает состояние разворачивания всех узлов в TreeView.
- **ToggleVirtualization()**: Переключает состояние виртуализации и обновляет связанные свойства.
- **PerformSearch()**: Переопределяет метод поиска для обработки поиска внутри TreeView при отключенной виртуализации.
- **HighlightItem(JsonTreeItem item, JsonTreeItem? previousItem = null)**: Выделяет указанный элемент в TreeView.

### SearchViewModel

Класс `SearchViewModel` обрабатывает логику для отдельного окна поиска при включенной виртуализации.

#### Ключевые свойства

- **SearchResults**: `ObservableCollection` объектов `JsonTreeItem`, представляющих текущий результат поиска.
- **SearchQuery**: Текущий поисковый запрос, введенный пользователем.
- **HasSearched**: Указывает, был ли выполнен поиск.
- **TotalMatches**: Общее количество найденных совпадений.
- **CurrentMatch**: Индекс текущего отображаемого совпадения.

#### Команды

- **SearchCommand**: Выполняет поиск на основе `SearchQuery`.
- **NextSearchResultCommand**: Переходит к следующему результату поиска.
- **PreviousSearchResultCommand**: Переходит к предыдущему результату поиска.
- **GotFocusCommand**: Обрабатывает событие получения фокуса текстовым полем поиска.
- **LostFocusCommand**: Обрабатывает событие потери фокуса текстовым полем поиска.

#### Методы

- **PerformSearch()**: Выполняет поиск с использованием `ISearchService` и обновляет результаты поиска.
- **ExecuteNextSearchResult()**: Переходит к следующему совпадению и обновляет `SearchResults`.
- **ExecutePreviousSearchResult()**: Переходит к предыдущему совпадению и обновляет `SearchResults`.
- **UpdateSearchResults()**: Обновляет `SearchResults` на основе текущего совпадения.

### SearchViewModelBase

Абстрактный базовый класс, предоставляющий общую функциональность для моделей представления, связанных с поиском.

#### Ключевые свойства

- **SearchQuery**: Текущий поисковый запрос.
- **HasSearched**: Указывает, был ли выполнен поиск.
- **TotalMatches**: Общее количество найденных совпадений.
- **CurrentMatch**: Индекс текущего совпадения.
- **IsSearchButtonVisible**: Управляет видимостью кнопки поиска.
- **AreNavigationButtonsVisible**: Управляет видимостью кнопок навигации на основе количества совпадений.

#### Команды

- **SearchCommand**: Команда для инициирования поиска.
- **NextSearchResultCommand**: Команда для перехода к следующему результату поиска.
- **PreviousSearchResultCommand**: Команда для перехода к предыдущему результату поиска.
- **GotFocusCommand**: Команда для обработки события получения фокуса текстовым полем поиска.
- **LostFocusCommand**: Команда для обработки события потери фокуса текстовым полем поиска.

#### Методы

- **ExecuteSearch()**: Абстрактный метод для выполнения поиска.
- **ExecuteNextSearchResult()**: Абстрактный метод для перехода к следующему результату поиска.
- **ExecutePreviousSearchResult()**: Абстрактный метод для перехода к предыдущему результату поиска.
- **PerformSearch()**: Абстрактный метод, который должен быть реализован в производных классах.

### Сервисы

#### IJsonParser

- **Назначение**: Парсит JSON-файлы в иерархическую структуру объектов `JsonTreeItem`.
- **Ключевые методы**:
  - **ParseJsonAsync(string filePath)**: Асинхронно парсит JSON-файл и возвращает коллекцию `JsonTreeItem`.

#### ISearchService

- **Назначение**: Предоставляет возможности поиска внутри данных JSON.
- **Ключевые методы**:
  - **FindMatches(ObservableCollection<JsonTreeItem> items, string query)**: Ищет совпадения в предоставленных элементах дерева JSON на основе запроса.

#### IFileService

- **Назначение**: Обрабатывает операции, связанные с файлами.
- **Ключевые методы**:
  - **ValidateFileSize(string filePath, double maxFileSizeInMegaByte)**: Проверяет, что размер файла не превышает максимальный допустимый размер.
  - **GetFileSizeInMegaBytes(string filePath)**: Возвращает размер файла в мегабайтах.

#### IProgressUpdater

- **Назначение**: Обновляет прогресс-бар во время загрузки и парсинга файла.
- **Ключевые методы**:
  - **UpdateProgressAsync(Action<double> updateAction, double estimatedTime, Func<bool> isComplete)**: Асинхронно обновляет прогресс-бар на основе оценочного времени.

#### ISpeedManager

- **Назначение**: Управляет сохранением и загрузкой скоростей парсинга для оценки прогресса.
- **Ключевые методы**:
  - **LoadSpeed()**: Загружает последнюю записанную скорость парсинга.
  - **SaveSpeed(double speed)**: Сохраняет текущую скорость парсинга для будущего использования.

#### IClipboardService

- **Назначение**: Предоставляет функциональность для копирования текста в буфер обмена.
- **Ключевые методы**:
  - **SetText(string text)**: Копирует предоставленный текст в буфер обмена.

#### IFileDialogService

- **Назначение**: Обрабатывает открытие диалоговых окон для выбора файлов.
- **Ключевые методы**:
  - **OpenFile(string filter)**: Открывает диалоговое окно с указанным фильтром и возвращает выбранный путь к файлу.

#### INavigationService

- **Назначение**: Управляет навигацией между различными представлениями или окнами.
- **Ключевые методы**:
  - **OpenSearchWindow(SearchViewModel viewModel)**: Открывает окно поиска с предоставленной моделью представления.

### Команды

#### RelayCommand

- **Назначение**: Реализует интерфейс `ICommand` для простых команд.
- **Использование**: Используется для синхронных команд, которые не требуют асинхронного выполнения.

#### AsyncRelayCommand

- **Назначение**: Реализует интерфейс `ICommand` для асинхронных команд.
- **Использование**: Используется для команд, которые выполняют асинхронные операции, такие как загрузка и парсинг файлов.

### Модели данных

#### JsonTreeItem

- **Назначение**: Представляет узел в TreeView JSON.
- **Свойства**:
  - **Name**: Имя свойства JSON.
  - **Value**: Значение свойства JSON.
  - **Children**: Коллекция дочерних объектов `JsonTreeItem`.
  - **Parent**: Родительский объект `JsonTreeItem`.
  - **IsExpanded**: Указывает, развернут ли узел в TreeView.
  - **IsSelected**: Указывает, выбран ли узел.
  - **Level**: Уровень глубины узла в дереве.
- **Методы**:
  - **CloneWithoutChildren()**: Создает неглубокую копию `JsonTreeItem` без его дочерних элементов.

## Заключение

Приложение JSON Viewer предоставляет эффективный и удобный способ просмотра и поиска данных в формате JSON. Используя WPF и паттерн MVVM, приложение разделяет ответственность и поддерживает чистую архитектуру. Такие функции, как виртуализация и оценка прогресса, делают его подходящим для обработки больших JSON-файлов. Функциональность поиска, как в главном окне, так и в окне поиска, предлагает гибкость в зависимости от предпочтений пользователя и соображений производительности.

## Руководство по использованию

1. **Запуск приложения**: Откройте приложение, чтобы получить доступ к главному окну.
2. **Открытие JSON-файла**:
   - Нажмите на кнопку "Открыть JSON файл".
   - Выберите JSON-файл в диалоговом окне (максимальный размер 500 МБ).
3. **Просмотр данных JSON**:
   - Данные JSON будут отображены в TreeView после завершения парсинга.
   - Используйте функциональность разворачивания/сворачивания для навигации по иерархии JSON.
   - Щелкните правой кнопкой мыши на узлах для копирования имен, значений или обоих свойств.
4. **Переключение виртуализации**:
   - По умолчанию виртуализация включена для улучшения производительности при больших файлах.
   - Нажмите на кнопку "Выключить\Включить виртуализацию", чтобы отключить или включить виртуализацию.
5. **Поиск по данным JSON**:
   - **Без виртуализации**:
     - Отключите виртуализацию, чтобы включить поиск внутри TreeView.
     - Введите поисковый запрос в появившейся панели поиска.
     - Используйте кнопку "Искать" и кнопки навигации для поиска совпадений.
   - **С виртуализацией**:
     - Оставьте виртуализацию включенной.
     - Нажмите на кнопку "Поиск", чтобы открыть окно поиска.
     - Введите поисковый запрос и перемещайтесь по результатам, отображаемым как отдельные ветки.

## Примечания

- **Соображения производительности**: Виртуализацию следует оставлять включенной для больших JSON-файлов, чтобы обеспечить плавную работу. Отключение виртуализации рендерит все узлы, что может повлиять на производительность при больших наборах данных.
- **Оценка прогресса**: Первый парсинг файла может не иметь точной оценки прогресса, так как она основывается на ранее записанных скоростях. Последующие загрузки файлов будут иметь улучшенную оценку.
